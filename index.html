<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Calificaciones - Institución XYZ</title>
  <style>
    /* ===== ESTILOS GENERALES Y RESPONSIVOS ===== */
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom, #cce0ff, #e6e6e6);
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      background: #fff;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 1400px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
    }
    header {
      border-bottom: 2px solid #003366;
      margin-bottom: 20px;
      padding-bottom: 10px;
    }
    header h1 {
      text-align: center;
      color: #003366;
      margin: 0;
      font-size: 2em;
    }
    .header-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .subject-select label,
    .rubric-display { font-weight: bold; }
    /* Se asocian los inputs a sus etiquetas con "for" */
    .subject-select label { margin-right: 5px; }
    .subject-select select { margin-right: 5px; }
    .subject-select button { margin-right: 5px; padding: 5px 10px; font-size: 0.9em; }
    .partial-tabs button {
      background: #0056b3;
      color: #fff;
      border: none;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .partial-tabs button.active,
    .partial-tabs button:hover { background: #003d80; }
    .rubric-display button,
    .cred-btn { margin-left: 10px; padding: 5px 10px; font-size: 0.9rem; cursor: pointer; }
    /* Botón para cerrar sesión */
    #signOutBtn {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 5px 10px;
      margin-left: 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    main { padding: 10px 0; }
    .eval-controls, .student-controls, .action-section { text-align: center; margin: 15px 0; }
    .btn {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 8px 12px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn:hover { background: #0056b3; }
    .table-container {
      overflow-x: auto;
      background: #fff;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }
    table, th, td { border: 1px solid #ccc; }
    th {
      background: #003366;
      color: #fff;
      padding: 10px;
      text-align: center;
      white-space: nowrap;
    }
    td {
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }
    td input, td select {
      padding: 4px;
      text-align: center;
      border: 1px solid #aaa;
      border-radius: 3px;
    }
    .exam-average, .task-average, .practice-average, .total-partial {
      background-color: #d1e7dd;
    }
    @media print {
      body { background: #fff; }
      .container { box-shadow: none; }
      .table-container { overflow: visible; }
      td::after {
        content: "";
        display: block;
        border-bottom: 1px dashed #000;
        margin-top: 5px;
      }
      @page { size: A4 landscape; margin: 20mm; }
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      position: relative;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #333;
    }
    #loginModal .modal-content { max-width: 400px; }
    #loginModal h2 { margin-top: 0; text-align: center; }
    #loginModal input { width: 100%; padding: 8px; margin: 10px 0; }
    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.8em;
      color: #555;
    }
    @media (max-width: 768px) {
      .container { margin: 10px; padding: 10px; }
      header h1 { font-size: 1.5em; }
      .partial-tabs button { padding: 6px 10px; font-size: 0.9em; }
      th, td { font-size: 0.8em; padding: 6px; }
      .btn, .cred-btn { padding: 6px 10px; font-size: 0.8em; }
    }
  </style>
  <!-- Incluir Firebase y dependencias (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- Modal General -->
  <div id="modalOverlay" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Modal de Login -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Iniciar Sesión</h2>
      <label for="loginUser">Usuario (correo):</label>
      <input type="text" id="loginUser" placeholder="ej. fco.lopezvelazquez@gmail.com">
      <label for="loginPass">Contraseña:</label>
      <input type="password" id="loginPass" placeholder="Ingrese contraseña">
      <button id="loginBtn" class="btn">Acceder</button>
      <button id="configCred" class="cred-btn">Configurar Credenciales</button>
      <p style="text-align:center; font-size:0.8em; margin-top:10px;">
        Creada y diseñada por Francisco López Velázquez
      </p>
    </div>
  </div>

  <!-- Contenedor principal -->
  <div class="container" id="appContainer" style="display:none;">
    <header>
      <h1>Sistema de Calificaciones</h1>
      <div class="header-controls">
        <div class="subject-select">
          <label for="subjectSelect">Materia:</label>
          <select id="subjectSelect"></select>
          <button id="addSubject" class="cred-btn">Agregar Materia</button>
          <button id="editSubject" class="cred-btn">Editar Materia</button>
          <button id="shareVersion" class="cred-btn">Compartir Versión</button>
        </div>
        <div class="partial-tabs">
          <button class="tab-btn" data-partial="1">Parcial 1</button>
          <button class="tab-btn" data-partial="2">Parcial 2</button>
          <button class="tab-btn" data-partial="3">Parcial 3</button>
          <button class="tab-btn" data-partial="4">Parcial 4</button>
        </div>
        <div class="rubric-display">
          Rúbrica: Exámenes: <span id="weightExam">45%</span>, Tareas: <span id="weightTask">25%</span>,
          Prácticas: <span id="weightPractice">30%</span>, Participación: <span id="weightPart">5%</span>
          <button id="editRubric" class="btn">Editar Rúbrica</button>
        </div>
        <!-- Botón para cerrar sesión (solo visible para el propietario) -->
        <div id="signOutContainer" style="display: none;">
          <button id="signOutBtn">Cerrar sesión</button>
        </div>
      </div>
    </header>
    <main>
      <section class="eval-controls">
        <button id="addExamEval" class="btn">Agregar Ex</button>
        <button id="addTaskEval" class="btn">Agregar Ta</button>
        <button id="addPracticeEval" class="btn">Agregar Pr</button>
      </section>
      <section class="student-controls">
        <button id="addStudent" class="btn">Agregar Alumno</button>
      </section>
      <section class="team-section">
        <h2>Equipos (Prácticas)</h2>
        <div class="table-container">
          <button id="addTeam" class="btn">Agregar Equipo</button>
          <table id="teamTable">
            <thead id="teamHeader"></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <section class="grade-section">
        <h2>Calificaciones - Parcial <span id="currentPartialDisplay">1</span></h2>
        <div class="table-container">
          <table id="gradeTable">
            <thead>
              <tr id="groupHeaderRow">
                <th rowspan="2">N° LS</th>
                <th rowspan="2">Alumno</th>
                <th rowspan="2">Equipo</th>
                <th class="exam-group" colspan="0">Exámenes</th>
                <th class="task-group" colspan="0">Tareas</th>
                <th class="practice-group" colspan="0">Prácticas</th>
                <th rowspan="2">Extra Ex.</th>
                <th rowspan="2">Extra Ta.</th>
                <th rowspan="2">Extra Pr.</th>
                <th rowspan="2">Extra Parcial</th>
                <th rowspan="2">Extra Total</th>
                <th rowspan="2">Participación (5%)</th>
                <th rowspan="2">Faltas</th>
                <th rowspan="2">Deducciones</th>
                <th rowspan="2">Total Parcial</th>
                <th rowspan="2">Acciones</th>
              </tr>
              <tr id="dynamicHeader"></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <section class="action-section">
        <button id="exportExcel" class="btn">Exportar Excel</button>
        <button id="exportPDF" class="btn">Exportar PDF</button>
        <button id="printGrades" class="btn">Imprimir Parcial</button>
      </section>
    </main>
    <footer>
      Pagina creada y diseñada por Francisco López Velázquez
    </footer>
  </div>

  <script>
    (function() {
      /***********************
       * 1. Variables Globales: Datos
       ***********************/
      const subjectsConfig = {
        circuitos: {
          name: "Circuitos Eléctricos",
          semester: "ene-jul",
          year: 2023,
          rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
          parcials: {
            "1": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "2": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "3": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "4": { examEvals: [], taskEvals: [], practiceEvals: [] }
          }
        },
        tt6: {
          name: "TT6",
          semester: "ene-jul",
          year: 2023,
          rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
          parcials: {
            "1": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "2": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "3": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "4": { examEvals: [], taskEvals: [], practiceEvals: [] }
          }
        },
        instalaciones: {
          name: "Instalaciones y Control Eléctrico",
          semester: "ago-dic",
          year: 2023,
          rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
          parcials: {
            "1": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "2": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "3": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "4": { examEvals: [], taskEvals: [], practiceEvals: [] }
          }
        },
        fisica4: {
          name: "Física 4",
          semester: "ago-dic",
          year: 2023,
          rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
          parcials: {
            "1": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "2": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "3": { examEvals: [], taskEvals: [], practiceEvals: [] },
            "4": { examEvals: [], taskEvals: [], practiceEvals: [] }
          }
        }
      };

      const students = [
        { listNumber: 1, name: "Juan Pérez", team: "E1", subject: "circuitos", partials: {} },
        { listNumber: 2, name: "María García", team: "E2", subject: "circuitos", partials: {} },
        { listNumber: 3, name: "Carlos López", team: "E1", subject: "tt6", partials: {} }
      ];

      const teams = {
        circuitos: [
          { id: "E1", name: "Equipo E1", head: "Encargado 1", partials: {} },
          { id: "E2", name: "Equipo E2", head: "Encargado 2", partials: {} }
        ],
        tt6: [
          { id: "E1", name: "Equipo A", head: "Encargado A", partials: {} },
          { id: "E2", name: "Equipo B", head: "Encargado B", partials: {} }
        ],
        instalaciones: [
          { id: "E1", name: "Equipo X", head: "Encargado X", partials: {} },
          { id: "E2", name: "Equipo Y", head: "Encargado Y", partials: {} }
        ],
        fisica4: [
          { id: "E1", name: "Equipo F1", head: "Encargado F1", partials: {} },
          { id: "E2", name: "Equipo F2", head: "Encargado F2", partials: {} }
        ]
      };

      /***********************
       * 2. Firebase Configuración y Firestore
       ***********************/
      const firebaseConfig = {
        apiKey: "AIzaSyDsoLZHDpR8EEyvs5tJ7gF1tE7eKS-ZGcU",
        authDomain: "controlescolar-a184f.firebaseapp.com",
        projectId: "controlescolar-a184f",
        storageBucket: "controlescolar-a184f.firebasestorage.app",
        messagingSenderId: "213806947943",
        appId: "1:213806947943:web:996ab97cdd805998f0bec2"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      /***********************
       * 3. Variables de Estado
       ***********************/
      const urlParams = new URLSearchParams(window.location.search);
      let readOnlyMode = urlParams.get("readonly") === "true";
      let urlSubject = urlParams.get("subject");
      let urlPartial = parseInt(urlParams.get("partial"));
      let currentSubject = (urlSubject && subjectsConfig[urlSubject]) ? urlSubject : "circuitos";
      let currentPartial = (!isNaN(urlPartial) && urlPartial > 0) ? urlPartial : 1;
      let isOwner = false;

      /***********************
       * 4. Persistencia en Firestore
       ***********************/
      function saveSubjects() {
        for (const key in subjectsConfig) {
          db.collection("subjects").doc(key).set(subjectsConfig[key])
            .catch(err => console.error("Error guardando subject", key, err));
        }
      }
      function saveStudents() {
        students.forEach(student => {
          db.collection("students").doc("stu_" + student.listNumber).set(student)
            .catch(err => console.error("Error guardando student", student.listNumber, err));
        });
      }
      function saveTeams() {
        for (const subject in teams) {
          teams[subject].forEach(team => {
            const docId = subject + "_" + team.id;
            db.collection("teams").doc(docId).set({ ...team, subject: subject })
              .catch(err => console.error("Error guardando team", docId, err));
          });
        }
      }
      let saveTimeout; // Declarada UNA sola vez
      function debounceSaveData() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          console.log("Guardando datos en Firestore...");
          saveData();
        }, 500);
      }
      function saveData() {
        saveSubjects();
        saveStudents();
        saveTeams();
      }

      /***********************
       * 5. Funciones de Interfaz
       ***********************/
      function buildSubjectSelect() {
        const select = document.getElementById("subjectSelect");
        select.innerHTML = "";
        for (let key in subjectsConfig) {
          const subj = subjectsConfig[key];
          const option = document.createElement("option");
          option.value = key;
          option.textContent = `${subj.name} (${subj.semester}, ${subj.year})`;
          select.appendChild(option);
        }
        select.value = currentSubject;
      }
      function updateRubricDisplay() {
        const cfg = subjectsConfig[currentSubject];
        document.getElementById("weightExam").textContent = cfg.rubric.exam + "%";
        document.getElementById("weightTask").textContent = cfg.rubric.task + "%";
        document.getElementById("weightPractice").textContent = cfg.rubric.practice + "%";
        document.getElementById("weightPart").textContent = cfg.rubric.participation + "%";
      }
      function updatePartialDisplay() {
        document.getElementById("currentPartialDisplay").textContent = currentPartial;
      }
      function buildDynamicHeader() {
        const headerRow = document.getElementById("dynamicHeader");
        headerRow.innerHTML = "";
        const cfg = subjectsConfig[currentSubject].parcials[currentPartial];
        cfg.examEvals.forEach(evalObj => {
          const th = document.createElement("th");
          th.textContent = evalObj.name;
          headerRow.appendChild(th);
        });
        const thExamAvg = document.createElement("th");
        thExamAvg.textContent = "Promedio Exámenes";
        headerRow.appendChild(thExamAvg);
        cfg.taskEvals.forEach(evalObj => {
          const th = document.createElement("th");
          th.textContent = evalObj.name;
          headerRow.appendChild(th);
        });
        const thTaskAvg = document.createElement("th");
        thTaskAvg.textContent = "Promedio Tareas";
        headerRow.appendChild(thTaskAvg);
        cfg.practiceEvals.forEach(evalObj => {
          const th = document.createElement("th");
          th.textContent = evalObj.name;
          headerRow.appendChild(th);
        });
        const thPracticeAvg = document.createElement("th");
        thPracticeAvg.textContent = "Promedio Prácticas";
        headerRow.appendChild(thPracticeAvg);
        buildGroupHeader();
      }
      function buildGroupHeader() {
        const cfg = subjectsConfig[currentSubject].parcials[currentPartial];
        const examColspan = cfg.examEvals.length + 1;
        const taskColspan = cfg.taskEvals.length + 1;
        const practiceColspan = cfg.practiceEvals.length + 1;
        document.querySelector(".exam-group").setAttribute("colspan", examColspan);
        document.querySelector(".task-group").setAttribute("colspan", taskColspan);
        document.querySelector(".practice-group").setAttribute("colspan", practiceColspan);
      }
      function buildTeamTable() {
        const teamTableHead = document.getElementById("teamHeader");
        const teamTableBody = document.querySelector("#teamTable tbody");
        teamTableHead.innerHTML = "";
        teamTableBody.innerHTML = "";
        const cfg = subjectsConfig[currentSubject].parcials[currentPartial];
        let headerHTML = "<tr><th>Equipo</th><th>Encargado</th>";
        cfg.practiceEvals.forEach(evalObj => { headerHTML += `<th>${evalObj.name}</th>`; });
        headerHTML += "<th>Acciones</th></tr>";
        teamTableHead.innerHTML = headerHTML;
        const subjectTeams = teams[currentSubject] || [];
        subjectTeams.forEach(team => {
          if (!team.partials) team.partials = {};
          if (!team.partials[currentPartial]) {
            team.partials[currentPartial] = Array(cfg.practiceEvals.length).fill(0);
          }
          let rowHTML = `<tr data-team-id="${team.id}"><td>${team.name}</td><td>${team.head}</td>`;
          team.partials[currentPartial].forEach((val, idx) => {
            rowHTML += `<td><input type="number" class="team-practice-input" data-team-id="${team.id}" data-index="${idx}" min="0" max="10" step="0.1" value="${val || 0}"></td>`;
          });
          rowHTML += `<td>
                        <button class="edit-team btn">Editar</button>
                        <button class="delete-team btn">Eliminar</button>
                      </td></tr>`;
          teamTableBody.innerHTML += rowHTML;
        });
        document.querySelectorAll(".team-practice-input").forEach(input => {
          input.addEventListener("input", (e) => {
            const teamId = e.target.getAttribute("data-team-id");
            const idx = parseInt(e.target.getAttribute("data-index"));
            const newVal = parseFloat(e.target.value) || 0;
            const subjectTeams = teams[currentSubject];
            const team = subjectTeams.find(t => t.id === teamId);
            if(team) {
              if (!team.partials) team.partials = {};
              if (!team.partials[currentPartial]) {
                team.partials[currentPartial] = Array(subjectsConfig[currentSubject].parcials[currentPartial].practiceEvals.length).fill(0);
              }
              team.partials[currentPartial][idx] = newVal;
              console.log("Team " + teamId + " práctica " + idx + " actualizada a: " + newVal);
              document.querySelectorAll("#gradeTable tbody tr").forEach(row => {
                const stuTeamSelect = row.querySelector(".student-team");
                const stuTeam = stuTeamSelect ? stuTeamSelect.value : "";
                if(stuTeam === teamId) {
                  const practiceInputs = row.querySelectorAll(".practice-input");
                  if(practiceInputs[idx]) { practiceInputs[idx].value = newVal; recalculateRow(row); }
                }
              });
              debounceSaveData();
            }
          });
        });
        document.querySelectorAll(".edit-team").forEach(btn => {
          btn.onclick = (e) => {
            const row = e.target.closest("tr");
            const teamId = row.getAttribute("data-team-id");
            const subjectTeams = teams[currentSubject];
            const team = subjectTeams.find(t => t.id === teamId);
            if(team) {
              let content = `<h3>Editar Equipo</h3>
                <label for="editTeamName">Nombre:</label>
                <input type="text" id="editTeamName" value="${team.name}"><br>
                <label for="editTeamHead">Encargado:</label>
                <input type="text" id="editTeamHead" value="${team.head}"><br>
                <button id="saveTeam" class="btn">Guardar</button>`;
              showModal(content);
              document.getElementById("saveTeam").onclick = () => {
                team.name = document.getElementById("editTeamName").value.trim();
                team.head = document.getElementById("editTeamHead").value.trim();
                console.log("Equipo " + teamId + " editado.");
                modalElement.style.display = "none";
                buildTeamTable();
                buildGradeTable();
                debounceSaveData();
              };
            }
          };
        });
        document.querySelectorAll(".delete-team").forEach(btn => {
          btn.onclick = (e) => {
            const row = e.target.closest("tr");
            const teamId = row.getAttribute("data-team-id");
            if(confirm("¿Estás seguro de eliminar este equipo?")) {
              teams[currentSubject] = teams[currentSubject].filter(t => t.id !== teamId);
              console.log("Equipo " + teamId + " eliminado.");
              buildTeamTable();
              buildGradeTable();
              debounceSaveData();
            }
          };
        });
      }
      function buildGradeTable() {
        const tbody = document.getElementById("gradeTable").querySelector("tbody");
        tbody.innerHTML = "";
        const cfg = subjectsConfig[currentSubject].parcials[currentPartial];
        const filteredStudents = students.filter(s => s.subject === currentSubject);
        filteredStudents.forEach(student => {
          if (!student.partials[currentPartial]) {
            student.partials[currentPartial] = {
              exams: Array(cfg.examEvals.length).fill(0),
              tasks: Array(cfg.taskEvals.length).fill(0),
              practices: Array(cfg.practiceEvals.length).fill(0),
              extraExam: 0,
              extraTask: 0,
              extraPractice: 0,
              extraParcial: 0,
              participation: 0,
              absences: 0,
              deductions: [],
              total: 0
            };
          } else {
            while (student.partials[currentPartial].exams.length < cfg.examEvals.length) { student.partials[currentPartial].exams.push(0); }
            while (student.partials[currentPartial].tasks.length < cfg.taskEvals.length) { student.partials[currentPartial].tasks.push(0); }
            while (student.partials[currentPartial].practices.length < cfg.practiceEvals.length) { student.partials[currentPartial].practices.push(0); }
            if (student.partials[currentPartial].extraParcial === undefined) { student.partials[currentPartial].extraParcial = 0; }
            if (!student.partials[currentPartial].deductions) { student.partials[currentPartial].deductions = []; }
          }
          const partialData = student.partials[currentPartial];
          let rowHTML = `<tr data-list="${student.listNumber}">
            <td>${student.listNumber}</td>
            <td contenteditable="true" class="student-name">${student.name}</td>
            <td>
              <label for="studentTeam_${student.listNumber}">Equipo:</label>
              <select class="student-team" id="studentTeam_${student.listNumber}">
                ${teams[currentSubject].map(team => `<option value="${team.id}" ${team.id === student.team ? "selected" : ""}>${team.name}</option>`).join('')}
              </select>
            </td>`;
          cfg.examEvals.forEach((evalObj, index) => {
            let val = partialData.exams[index];
            if(val === "" || val == null) { val = 0; }
            rowHTML += `<td><input type="number" class="exam-input" data-index="${index}" min="0" max="10" step="0.1" value="${val}"></td>`;
          });
          rowHTML += `<td class="exam-average">0</td>`;
          cfg.taskEvals.forEach((evalObj, index) => {
            let val = partialData.tasks[index];
            if(val === "" || val == null) { val = 0; }
            rowHTML += `<td><input type="number" class="task-input" data-index="${index}" min="0" max="10" step="0.1" value="${val}"></td>`;
          });
          rowHTML += `<td class="task-average">0</td>`;
          cfg.practiceEvals.forEach((evalObj, index) => {
            const subjectTeams = teams[currentSubject];
            const teamObj = subjectTeams.find(t => t.id === student.team);
            let grade = 0;
            if(teamObj && teamObj.partials && teamObj.partials[currentPartial] && teamObj.partials[currentPartial][index] !== undefined) { 
              grade = teamObj.partials[currentPartial][index]; 
            }
            partialData.practices[index] = grade;
            rowHTML += `<td><input type="number" class="practice-input" data-index="${index}" min="0" max="10" step="0.1" value="${grade || 0}" readonly></td>`;
          });
          rowHTML += `<td class="practice-average">0</td>`;
          rowHTML += `
            <td><input type="number" class="extra-exam" min="0" max="2" step="0.1" value="${partialData.extraExam || 0}"></td>
            <td><input type="number" class="extra-task" min="0" max="2" step="0.1" value="${partialData.extraTask || 0}"></td>
            <td><input type="number" class="extra-practice" min="0" max="2" step="0.1" value="${partialData.extraPractice || 0}"></td>
            <td><input type="number" class="extra-parcial" min="0" step="0.1" value="${partialData.extraParcial || 0}"></td>
            <td class="extra-total">0</td>
            <td><input type="number" class="participation" min="0" max="5" step="0.1" value="${partialData.participation || 0}"></td>
            <td><input type="number" class="absences" min="0" step="1" value="${partialData.absences || 0}"></td>
            <td class="deductions"><span class="deduction-sum">0</span> <button class="deduct-btn btn">Ded</button></td>
            <td class="total-partial">0</td>
            <td>
              <button class="row-action-btn btn">Ver Ded.</button>
              <button class="delete-student btn">Eliminar</button>
            </td>
          </tr>`;
          tbody.innerHTML += rowHTML;
        });
        attachTableListeners();
        recalculateAll();
        if(readOnlyMode) { setReadOnly(); }
        debounceSaveData();
      }
      function recalculateRow(row) {
        const rubric = subjectsConfig[currentSubject].rubric;
        let examSum = 0, examCount = 0;
        row.querySelectorAll(".exam-input").forEach(input => { examSum += parseFloat(input.value) || 0; examCount++; });
        const examAvg = examCount ? examSum / examCount : 0;
        row.querySelector(".exam-average").textContent = examAvg.toFixed(2);
        let taskSum = 0, taskCount = 0;
        row.querySelectorAll(".task-input").forEach(input => { taskSum += parseFloat(input.value) || 0; taskCount++; });
        const taskAvg = taskCount ? taskSum / taskCount : 0;
        row.querySelector(".task-average").textContent = taskAvg.toFixed(2);
        let practiceSum = 0, practiceCount = 0;
        row.querySelectorAll(".practice-input").forEach(input => { practiceSum += parseFloat(input.value) || 0; practiceCount++; });
        const practiceAvg = practiceCount ? practiceSum / practiceCount : 0;
        row.querySelector(".practice-average").textContent = practiceAvg.toFixed(2);
        const extraExam = parseFloat(row.querySelector(".extra-exam").value) || 0;
        const extraTask = parseFloat(row.querySelector(".extra-task").value) || 0;
        const extraPractice = parseFloat(row.querySelector(".extra-practice").value) || 0;
        const extraParcial = parseFloat(row.querySelector(".extra-parcial").value) || 0;
        const extraTotal = (extraExam * rubric.exam/100) + (extraTask * rubric.task/100) + (extraPractice * rubric.practice/100) + extraParcial;
        row.querySelector(".extra-total").textContent = extraTotal.toFixed(2);
        const participation = parseFloat(row.querySelector(".participation").value) || 0;
        const listNum = row.getAttribute("data-list");
        const student = students.find(s => s.listNumber == listNum);
        let deductionSum = 0;
        if(student && student.partials[currentPartial].deductions) {
          deductionSum = student.partials[currentPartial].deductions.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
        }
        row.querySelector(".deduction-sum").textContent = deductionSum.toFixed(2);
        const totalPartial = ((examAvg * rubric.exam/100) + (taskAvg * rubric.task/100) + (practiceAvg * rubric.practice/100) + extraTotal + (participation * rubric.participation/100)) - deductionSum - (parseFloat(row.querySelector(".absences").value) || 0);
        row.querySelector(".total-partial").textContent = totalPartial.toFixed(2);
        if(student) { student.partials[currentPartial].total = totalPartial; }
      }
      function recalculateAll() {
        document.querySelectorAll("#gradeTable tbody tr").forEach(row => recalculateRow(row));
      }
      function attachTableListeners() {
        document.querySelectorAll("#gradeTable tbody input").forEach(input => {
          input.addEventListener("input", () => {
            const row = input.closest("tr");
            saveRowData(row);
            recalculateRow(row);
            debounceSaveData();
          });
        });
        document.querySelectorAll(".student-team").forEach(select => {
          select.addEventListener("change", (e) => {
            const row = e.target.closest("tr");
            const listNum = row.getAttribute("data-list");
            const student = students.find(s => s.listNumber == listNum);
            if(student) { student.team = e.target.value; }
            propagateTeamGradeForRow(row);
            debounceSaveData();
          });
        });
        document.querySelectorAll(".student-name").forEach(cell => {
          cell.addEventListener("blur", (e) => {
            const row = e.target.closest("tr");
            const listNum = row.getAttribute("data-list");
            const student = students.find(s => s.listNumber == listNum);
            if(student) { student.name = e.target.textContent.trim(); }
            debounceSaveData();
          });
        });
        document.querySelectorAll(".deduct-btn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const row = e.target.closest("tr");
            const listNum = row.getAttribute("data-list");
            const student = students.find(s => s.listNumber == listNum);
            if(student) { openDeductionModal(student); }
          });
        });
        document.querySelectorAll(".row-action-btn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const row = e.target.closest("tr");
            const listNum = row.getAttribute("data-list");
            const student = students.find(s => s.listNumber == listNum);
            if(student) { openDeductionModal(student, true); }
          });
        });
        document.querySelectorAll(".delete-student").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const row = e.target.closest("tr");
            const listNum = parseInt(row.getAttribute("data-list"));
            if(confirm("¿Estás seguro de eliminar este alumno?")) {
              students.splice(students.findIndex(s => s.listNumber === listNum), 1);
              buildGradeTable();
              debounceSaveData();
            }
          });
        });
      }
      function saveRowData(row) {
        const listNum = row.getAttribute("data-list");
        const student = students.find(s => s.listNumber == listNum);
        if(!student) return;
        const partialData = student.partials[currentPartial];
        partialData.exams = [];
        row.querySelectorAll(".exam-input").forEach(input => { partialData.exams.push(parseFloat(input.value) || 0); });
        partialData.tasks = [];
        row.querySelectorAll(".task-input").forEach(input => { partialData.tasks.push(parseFloat(input.value) || 0); });
        partialData.extraExam = parseFloat(row.querySelector(".extra-exam").value) || 0;
        partialData.extraTask = parseFloat(row.querySelector(".extra-task").value) || 0;
        partialData.extraPractice = parseFloat(row.querySelector(".extra-practice").value) || 0;
        partialData.extraParcial = parseFloat(row.querySelector(".extra-parcial").value) || 0;
        partialData.participation = parseFloat(row.querySelector(".participation").value) || 0;
        partialData.absences = parseFloat(row.querySelector(".absences").value) || 0;
        debounceSaveData();
      }
      function propagateTeamGradeForRow(row) {
        const listNum = row.getAttribute("data-list");
        const student = students.find(s => s.listNumber == listNum);
        if(!student) return;
        const subjectTeams = teams[currentSubject];
        const teamObj = subjectTeams.find(t => t.id === student.team);
        if(teamObj && teamObj.partials && teamObj.partials[currentPartial]) {
          row.querySelectorAll(".practice-input").forEach((input, idx) => { input.value = teamObj.partials[currentPartial][idx] || 0; });
        }
        recalculateRow(row);
        debounceSaveData();
      }

      /***********************
       * 6. Funciones de Modal para Agregar/Editar Elementos
       ***********************/
      const modalElement = document.getElementById("modalOverlay"); // Declaramos modal UNA sola vez
      function showModal(contentHTML) {
        document.getElementById("modalBody").innerHTML = contentHTML;
        modalElement.style.display = "block";
      }
      document.querySelectorAll(".modal .close").forEach(closeBtn => {
        closeBtn.onclick = function() {
          this.parentElement.parentElement.style.display = "none";
        };
      });
      window.onclick = function(event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };
      function openDeductionModal(student, viewOnly = false) {
        let content = `<h3>Deducciones para ${student.name}</h3>
          <label for="dedAmount">Monto (-):</label>
          <input type="number" id="dedAmount" step="0.1"><br>
          <label for="dedReason">Motivo:</label>
          <input type="text" id="dedReason"><br>
          <label for="dedDate">Fecha:</label>
          <input type="date" id="dedDate"><br>`;
        if(!viewOnly) { content += `<button id="saveDed" class="btn">Agregar Deducción</button>`; }
        if(student.partials[currentPartial].deductions && student.partials[currentPartial].deductions.length > 0) {
          content += `<h4>Deducciones Registradas:</h4><ul>`;
          student.partials[currentPartial].deductions.forEach((ded) => {
            content += `<li>${ded.date} - ${ded.reason}: ${ded.amount} pts</li>`;
          });
          content += `</ul>`;
        } else {
          content += `<p>No hay deducciones registradas.</p>`;
        }
        showModal(content);
        if(!viewOnly) {
          document.getElementById("saveDed").onclick = () => {
            const amount = parseFloat(document.getElementById("dedAmount").value) || 0;
            const reason = document.getElementById("dedReason").value.trim();
            const date = document.getElementById("dedDate").value;
            if(amount <= 0 || !reason || !date) { alert("Complete todos los campos."); return; }
            if(!student.partials[currentPartial].deductions) student.partials[currentPartial].deductions = [];
            student.partials[currentPartial].deductions.push({ amount, reason, date });
            modalElement.style.display = "none";
            buildGradeTable();
            debounceSaveData();
          };
        }
      }

      /***********************
       * 7. Autenticación y Restricción de Edición
       ***********************/
      window.addEventListener("load", () => {
        if (readOnlyMode) {
          updateURLParams();
          document.getElementById("appContainer").style.display = "block";
          setReadOnly();
        } else {
          const loginModal = document.getElementById("loginModal");
          loginModal.style.display = "block";
          auth.onAuthStateChanged((user) => {
            if (user) {
              if(user.email === "fco.lopezvelazquez@gmail.com") {
                isOwner = true;
                document.getElementById("signOutContainer").style.display = "block";
                console.log("Usuario propietario autenticado.");
              } else {
                isOwner = false;
                setReadOnly();
                document.getElementById("signOutContainer").style.display = "none";
                console.log("Usuario no propietario; modo solo lectura.");
              }
              loginModal.style.display = "none";
              document.getElementById("appContainer").style.display = "block";
            } else {
              document.getElementById("appContainer").style.display = "none";
              loginModal.style.display = "block";
            }
          });
          document.getElementById("loginBtn").onclick = () => {
            const email = document.getElementById("loginUser").value.trim();
            const password = document.getElementById("loginPass").value;
            console.log("Intentando iniciar sesión con: " + email);
            auth.signInWithEmailAndPassword(email, password)
              .then(() => {
                document.getElementById("loginModal").style.display = "none";
                document.getElementById("appContainer").style.display = "block";
              })
              .catch((error) => { alert("Error: " + error.message); });
          };
        }
      });

      document.getElementById("signOutBtn").onclick = () => {
        auth.signOut()
          .then(() => {
            window.location.reload();
          })
          .catch(err => console.error("Error al cerrar sesión", err));
      };

      /***********************
       * 8. Carga Inicial y Escucha Realtime (Firestore)
       ***********************/
      function attachRealtimeListeners() {
        db.collection("subjects").onSnapshot(snapshot => {
          snapshot.forEach(doc => {
            subjectsConfig[doc.id] = doc.data();
          });
          buildSubjectSelect();
          updateRubricDisplay();
          buildDynamicHeader();
        });
        db.collection("students").onSnapshot(snapshot => {
          students.length = 0;
          snapshot.forEach(doc => {
            students.push(doc.data());
          });
          buildGradeTable();
        });
        db.collection("teams").onSnapshot(snapshot => {
          for (const subject in teams) { teams[subject] = []; }
          snapshot.forEach(doc => {
            const data = doc.data();
            const subject = data.subject;
            if (!teams[subject]) teams[subject] = [];
            teams[subject].push(data);
          });
          buildTeamTable();
        });
      }
      attachRealtimeListeners();

      function updateURLParams() {
        const url = new URL(window.location.href);
        url.searchParams.set("subject", currentSubject);
        url.searchParams.set("partial", currentPartial);
        if (!readOnlyMode) { url.searchParams.delete("readonly"); }
        window.history.pushState({}, '', url.toString());
      }
      function setReadOnly() {
        document.querySelectorAll("input, select, button").forEach(el => { el.disabled = true; });
        if (!document.getElementById("readOnlyNotice")) {
          const notice = document.createElement("p");
          notice.id = "readOnlyNotice";
          notice.textContent = "Modo Solo Lectura – No se permite la edición";
          notice.style.textAlign = "center";
          notice.style.fontWeight = "bold";
          notice.style.color = "#900";
          document.getElementById("appContainer").insertBefore(notice, document.getElementById("appContainer").firstChild);
        }
      }

      // Llamadas de carga inicial
      buildSubjectSelect();
      updateRubricDisplay();
      updatePartialDisplay();
      buildDynamicHeader();
      buildTeamTable();
      buildGradeTable();
    })();
  </script>
</body>
</html>
