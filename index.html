<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Escolar</title>
  <style>
    /* Diseño profesional e institucional: azul y blanco */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    main {
      padding: 1rem;
    }
    section {
      margin-bottom: 2rem;
      background: white;
      padding: 1rem;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #003366;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 0.5rem;
      text-align: left;
    }
    button {
      background-color: #003366;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.2rem;
      border-radius: 3px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    input, select {
      padding: 0.5rem;
      margin: 0.2rem;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    /* Estilos para modales */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 1rem;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 5px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
    }
    /* Estilos para impresión en A4 */
    @media print {
      body * {
        visibility: hidden;
      }
      #printable, #printable * {
        visibility: visible;
      }
      #printable {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Control Escolar</h1>
    <!-- Selección de materia y parcial -->
    <div>
      <label for="subjectSelect">Materia:</label>
      <select id="subjectSelect"></select>
      <label for="partialSelect">Parcial:</label>
      <select id="partialSelect">
        <option value="1">Parcial 1</option>
        <option value="2">Parcial 2</option>
        <option value="3">Parcial 3</option>
        <option value="4">Parcial 4</option>
      </select>
      <span id="userStatus"></span>
    </div>
  </header>
  <main>
    <!-- Gestión de Materias -->
    <section id="subjectsSection">
      <h2>Materias</h2>
      <button id="addSubjectBtn">Agregar Materia</button>
      <div id="subjectsList"></div>
    </section>
    <!-- Gestión de Evaluaciones -->
    <section id="evaluationsSection">
      <h2>Evaluaciones</h2>
      <button id="addExamBtn">Agregar Ex</button>
      <button id="addTaskBtn">Agregar Ta</button>
      <button id="addPracticeBtn">Agregar Pr</button>
    </section>
    <!-- Gestión de Alumnos -->
    <section id="studentsSection">
      <h2>Alumnos</h2>
      <button id="addStudentBtn">Agregar Alumno</button>
      <div id="studentsTableContainer">
        <table id="gradesTable">
          <thead id="gradesHeader"></thead>
          <tbody id="gradesBody"></tbody>
        </table>
      </div>
    </section>
    <!-- Gestión de Equipos -->
    <section id="teamsSection">
      <h2>Equipos</h2>
      <button id="addTeamBtn">Agregar Equipo</button>
      <div id="teamsTableContainer">
        <table id="teamsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Encargado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="teamsBody"></tbody>
        </table>
      </div>
    </section>
    <!-- Deducciones -->
    <section id="deductionsSection">
      <h2>Deducciones</h2>
      <button id="addDeductionBtn">Agregar Deducción</button>
      <div id="deductionsTableContainer">
        <table id="deductionsTable">
          <thead>
            <tr>
              <th>Motivo</th>
              <th>Fecha</th>
              <th>Cantidad</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="deductionsBody"></tbody>
        </table>
      </div>
    </section>
    <!-- Exportación y Presentación -->
    <section id="exportSection">
      <h2>Exportación y Presentación</h2>
      <button id="exportExcelBtn">Exportar a Excel</button>
      <button id="exportPDFBtn">Exportar a PDF</button>
      <button id="printPartialBtn">Imprimir Parcial</button>
      <button id="shareVersionBtn">Compartir Versión</button>
    </section>
  </main>
  
  <!-- Modal genérico -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="modalCloseBtn">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>
  
  <!-- Modal de Login -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>Iniciar Sesión</h2>
      <input type="email" id="loginEmail" placeholder="Correo electrónico">
      <input type="password" id="loginPassword" placeholder="Contraseña">
      <button id="loginSubmitBtn">Login</button>
    </div>
  </div>
  
  <!-- Firebase App y Auth (versiones compat para disponer de la variable global "firebase") -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <!-- jsPDF y AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- SheetJS para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  
  <script>
    // Ejecutar todo el código cuando el DOM esté listo
    document.addEventListener("DOMContentLoaded", () => {
      /* ---------------------- VARIABLES GLOBALES Y CONFIGURACIÓN ---------------------- */
      // Modo solo lectura si en la URL se incluye ?readonly=true
      let readOnly = new URLSearchParams(window.location.search).get('readonly') === 'true';
      let currentSubjectId = null;
      let currentPartial = "1";
      let currentUser = null;
      
      // Estructura de datos
      let data = {
        subjects: {},
        students: []
      };
      
      // Rúbrica por defecto
      const defaultRubric = {
        exams: 45,
        tasks: 25,
        practices: 30,
        participation: 5
      };
      
      // Configuración de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDsoLZHDpR8EEyvs5tJ7gF1tE7eKS-ZGcU",
        authDomain: "controlescolar-a184f.firebaseapp.com",
        projectId: "controlescolar-a184f",
        storageBucket: "controlescolar-a184f.firebasestorage.app",
        messagingSenderId: "213806947943",
        appId: "1:213806947943:web:996ab97cdd805998f0bec2"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      
      /* ---------------------- SELECCIÓN DE ELEMENTOS DE LA INTERFAZ ---------------------- */
      const subjectSelect = document.getElementById("subjectSelect");
      const partialSelect = document.getElementById("partialSelect");
      const subjectsListDiv = document.getElementById("subjectsList");
      const gradesHeader = document.getElementById("gradesHeader");
      const gradesBody = document.getElementById("gradesBody");
      const teamsBody = document.getElementById("teamsBody");
      const deductionsBody = document.getElementById("deductionsBody");
      const userStatus = document.getElementById("userStatus");
      
      // Botones principales
      const addSubjectBtn = document.getElementById("addSubjectBtn");
      const addExamBtn = document.getElementById("addExamBtn");
      const addTaskBtn = document.getElementById("addTaskBtn");
      const addPracticeBtn = document.getElementById("addPracticeBtn");
      const addStudentBtn = document.getElementById("addStudentBtn");
      const addTeamBtn = document.getElementById("addTeamBtn");
      const addDeductionBtn = document.getElementById("addDeductionBtn");
      const exportExcelBtn = document.getElementById("exportExcelBtn");
      const exportPDFBtn = document.getElementById("exportPDFBtn");
      const printPartialBtn = document.getElementById("printPartialBtn");
      const shareVersionBtn = document.getElementById("shareVersionBtn");
      
      // Modales
      const modal = document.getElementById("modal");
      const modalBody = document.getElementById("modalBody");
      const modalCloseBtn = document.getElementById("modalCloseBtn");
      const loginModal = document.getElementById("loginModal");
      const loginEmail = document.getElementById("loginEmail");
      const loginPassword = document.getElementById("loginPassword");
      const loginSubmitBtn = document.getElementById("loginSubmitBtn");
      
      /* ---------------------- FUNCIONES DE MODO EDICIÓN Y MODALES ---------------------- */
      // Actualiza la interfaz según el modo de edición o solo lectura
      function updateEditMode() {
        if(readOnly) {
          document.querySelectorAll("button").forEach(btn => btn.disabled = true);
          userStatus.textContent = "Modo Solo Lectura";
        } else {
          userStatus.textContent = currentUser ? `Usuario: ${currentUser.email}` : "No autenticado";
        }
      }
      
      // Funciones para mostrar y ocultar el modal genérico
      function showModal(contentHTML) {
        modalBody.innerHTML = contentHTML;
        modal.style.display = "block";
      }
      function hideModal() {
        modal.style.display = "none";
      }
      modalCloseBtn.addEventListener("click", hideModal);
      window.addEventListener("click", (event) => {
        if(event.target === modal) hideModal();
        if(event.target === loginModal) loginModal.style.display = "none";
      });
      
      /* ---------------------- PERSISTENCIA DE DATOS (localStorage) ---------------------- */
      function loadData() {
        const stored = localStorage.getItem("schoolData");
        if(stored) {
          try { data = JSON.parse(stored); } 
          catch(e) { console.error("Error al leer los datos:", e); }
        }
      }
      function saveData() {
        try { localStorage.setItem("schoolData", JSON.stringify(data)); }
        catch(e) { console.error("Error al guardar los datos:", e); }
      }
      
      /* ---------------------- ACTUALIZACIÓN DE LA INTERFAZ ---------------------- */
      // Actualiza el selector de materias
      function updateSubjectSelector() {
        subjectSelect.innerHTML = "";
        for (const subjId in data.subjects) {
          const option = document.createElement("option");
          option.value = subjId;
          option.textContent = data.subjects[subjId].name;
          subjectSelect.appendChild(option);
        }
        if(subjectSelect.options.length > 0) currentSubjectId = subjectSelect.options[0].value;
      }
      // Muestra el listado de materias con opción de editar
      function updateSubjectsList() {
        subjectsListDiv.innerHTML = "";
        for (const subjId in data.subjects) {
          const subj = data.subjects[subjId];
          const div = document.createElement("div");
          div.textContent = `${subj.name} (${subj.semester}, ${subj.year})`;
          if(!readOnly) {
            const editBtn = document.createElement("button");
            editBtn.textContent = "Editar";
            editBtn.addEventListener("click", () => { openEditSubjectModal(subjId); });
            div.appendChild(editBtn);
          }
          subjectsListDiv.appendChild(div);
        }
      }
      // Reconstruye los encabezados de la tabla de calificaciones
      function updateEvaluationsHeader() {
        gradesHeader.innerHTML = "";
        const headerRow = document.createElement("tr");
        ["Lista", "Nombre"].forEach(text => {
          const th = document.createElement("th");
          th.textContent = text;
          headerRow.appendChild(th);
        });
        if(currentSubjectId && data.subjects[currentSubjectId]) {
          const subj = data.subjects[currentSubjectId];
          const partialEvals = subj.evaluations[currentPartial] || { exams: [], tasks: [], practices: [] };
          partialEvals.exams.forEach(evalName => {
            const th = document.createElement("th");
            th.textContent = evalName;
            headerRow.appendChild(th);
          });
          partialEvals.tasks.forEach(evalName => {
            const th = document.createElement("th");
            th.textContent = evalName;
            headerRow.appendChild(th);
          });
          partialEvals.practices.forEach(evalName => {
            const th = document.createElement("th");
            th.textContent = evalName;
            headerRow.appendChild(th);
          });
          const thTotal = document.createElement("th");
          thTotal.textContent = "Total";
          headerRow.appendChild(thTotal);
        }
        gradesHeader.appendChild(headerRow);
      }
      // Actualiza la tabla de alumnos
      function updateStudentsTable() {
        gradesBody.innerHTML = "";
        data.students.forEach(student => {
          if(student.subjectId === currentSubjectId) {
            const tr = document.createElement("tr");
            const tdList = document.createElement("td");
            tdList.textContent = student.listNumber;
            tr.appendChild(tdList);
            const tdName = document.createElement("td");
            tdName.textContent = student.name;
            tr.appendChild(tdName);
            const partialData = student.partials[currentPartial] || { grades: { exams:{}, tasks:{}, practices:{} }, extras: { extraParcial:0 }, deductions: [] };
            let total = 0;
            if(currentSubjectId && data.subjects[currentSubjectId]) {
              const subj = data.subjects[currentSubjectId];
              const rubric = subj.rubric;
              const partialEvals = subj.evaluations[currentPartial] || { exams: [], tasks: [], practices: [] };
              partialEvals.exams.forEach(evalName => {
                const grade = partialData.grades.exams[evalName] || 0;
                total += grade * (rubric.exams / 100);
                const td = document.createElement("td");
                td.textContent = grade;
                tr.appendChild(td);
              });
              partialEvals.tasks.forEach(evalName => {
                const grade = partialData.grades.tasks[evalName] || 0;
                total += grade * (rubric.tasks / 100);
                const td = document.createElement("td");
                td.textContent = grade;
                tr.appendChild(td);
              });
              partialEvals.practices.forEach(evalName => {
                const grade = partialData.grades.practices[evalName] || 0;
                total += grade * (rubric.practices / 100);
                const td = document.createElement("td");
                td.textContent = grade;
                tr.appendChild(td);
              });
            }
            // Sumar extras y restar deducciones
            const extras = partialData.extras.extraParcial || 0;
            let deductions = 0;
            partialData.deductions.forEach(d => { deductions += d.cantidad; });
            total = total + extras - deductions;
            const tdTotal = document.createElement("td");
            tdTotal.textContent = total.toFixed(2);
            tr.appendChild(tdTotal);
            if(!readOnly) {
              const tdActions = document.createElement("td");
              const editBtn = document.createElement("button");
              editBtn.textContent = "Editar";
              editBtn.addEventListener("click", () => { openEditStudentModal(student.id); });
              tdActions.appendChild(editBtn);
              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "Eliminar";
              deleteBtn.addEventListener("click", () => { deleteStudent(student.id); });
              tdActions.appendChild(deleteBtn);
              tr.appendChild(tdActions);
            }
            gradesBody.appendChild(tr);
          }
        });
      }
      // Actualiza la tabla de equipos
      function updateTeamsTable() {
        teamsBody.innerHTML = "";
        if(currentSubjectId && data.subjects[currentSubjectId]) {
          const subj = data.subjects[currentSubjectId];
          const teams = subj.teams[currentPartial] || [];
          teams.forEach(team => {
            const tr = document.createElement("tr");
            const tdId = document.createElement("td");
            tdId.textContent = team.id;
            tr.appendChild(tdId);
            const tdName = document.createElement("td");
            tdName.textContent = team.name;
            tr.appendChild(tdName);
            const tdEncargado = document.createElement("td");
            tdEncargado.textContent = team.encargado;
            tr.appendChild(tdEncargado);
            const tdActions = document.createElement("td");
            if(!readOnly) {
              const editBtn = document.createElement("button");
              editBtn.textContent = "Editar";
              editBtn.addEventListener("click", () => { openEditTeamModal(team.id); });
              tdActions.appendChild(editBtn);
              const deleteBtn = document.createElement("button");
              deleteBtn.textContent = "Eliminar";
              deleteBtn.addEventListener("click", () => { deleteTeam(team.id); });
              tdActions.appendChild(deleteBtn);
            }
            tr.appendChild(tdActions);
            teamsBody.appendChild(tr);
          });
        }
      }
      // Actualiza la tabla de deducciones
      function updateDeductionsTable() {
        deductionsBody.innerHTML = "";
        data.students.forEach(student => {
          if(student.subjectId === currentSubjectId) {
            const partialData = student.partials[currentPartial];
            if(partialData && partialData.deductions) {
              partialData.deductions.forEach((ded, idx) => {
                const tr = document.createElement("tr");
                const tdMotivo = document.createElement("td");
                tdMotivo.textContent = ded.motivo;
                tr.appendChild(tdMotivo);
                const tdFecha = document.createElement("td");
                tdFecha.textContent = ded.fecha;
                tr.appendChild(tdFecha);
                const tdCantidad = document.createElement("td");
                tdCantidad.textContent = ded.cantidad;
                tr.appendChild(tdCantidad);
                const tdActions = document.createElement("td");
                if(!readOnly) {
                  const deleteBtn = document.createElement("button");
                  deleteBtn.textContent = "Eliminar";
                  deleteBtn.addEventListener("click", () => { deleteDeduction(student.id, idx); });
                  tdActions.appendChild(deleteBtn);
                }
                tr.appendChild(tdActions);
                deductionsBody.appendChild(tr);
              });
            }
          }
        });
      }
      
      /* ---------------------- FUNCIONES PARA ABRIR MODALES DE AGREGAR/EDITAR ---------------------- */
      // Agregar o editar materia
      function openEditSubjectModal(subjId = null) {
        let subj = { name: "", semester: "", year: "", rubric: defaultRubric };
        if(subjId) { subj = data.subjects[subjId]; }
        let html = `
          <h3>${subjId ? "Editar Materia" : "Agregar Materia"}</h3>
          <label>Nombre: <input type="text" id="subjectName" value="${subj.name}"></label><br>
          <label>Semestre: <input type="text" id="subjectSemester" value="${subj.semester}"></label><br>
          <label>Año: <input type="number" id="subjectYear" value="${subj.year || new Date().getFullYear()}"></label><br>
          <button id="saveSubjectBtn">${subjId ? "Guardar" : "Agregar"}</button>
        `;
        showModal(html);
        document.getElementById("saveSubjectBtn").addEventListener("click", () => {
          const name = document.getElementById("subjectName").value;
          const semester = document.getElementById("subjectSemester").value;
          const year = parseInt(document.getElementById("subjectYear").value);
          if(subjId) {
            data.subjects[subjId].name = name;
            data.subjects[subjId].semester = semester;
            data.subjects[subjId].year = year;
          } else {
            const newId = "subj_" + Date.now();
            data.subjects[newId] = {
              id: newId,
              name: name,
              semester: semester,
              year: year,
              rubric: defaultRubric,
              evaluations: {
                "1": { exams: [], tasks: [], practices: [] },
                "2": { exams: [], tasks: [], practices: [] },
                "3": { exams: [], tasks: [], practices: [] },
                "4": { exams: [], tasks: [], practices: [] }
              },
              teams: {
                "1": [],
                "2": [],
                "3": [],
                "4": []
              }
            };
          }
          saveData();
          hideModal();
          updateSubjectSelector();
          updateSubjectsList();
          updateEvaluationsHeader();
          updateStudentsTable();
          updateTeamsTable();
          updateDeductionsTable();
        });
      }
      // Agregar evaluación (examen, tarea o práctica)
      function openAddEvaluationModal(type) {
        let promptText = "";
        if(type === "exam") promptText = "Nombre del Examen:";
        if(type === "task") promptText = "Nombre de la Tarea:";
        if(type === "practice") promptText = "Nombre de la Práctica:";
        const evalName = prompt(promptText);
        if(evalName && currentSubjectId) {
          const subj = data.subjects[currentSubjectId];
          if(!subj.evaluations[currentPartial]) { subj.evaluations[currentPartial] = { exams: [], tasks: [], practices: [] }; }
          subj.evaluations[currentPartial][ type === "exam" ? "exams" : (type === "task" ? "tasks" : "practices") ].push(evalName);
          saveData();
          updateEvaluationsHeader();
          updateStudentsTable();
        }
      }
      // Editar alumno
      function openEditStudentModal(studentId) {
        const student = data.students.find(s => s.id === studentId);
        if(!student) return;
        let html = `
          <h3>Editar Alumno</h3>
          <label>Número de Lista: <input type="number" id="studentList" value="${student.listNumber}"></label><br>
          <label>Nombre: <input type="text" id="studentName" value="${student.name}"></label><br>
          <label>Equipo (ID): <input type="text" id="studentTeam" value="${student.teamId || ""}"></label><br>
          <button id="saveStudentBtn">Guardar</button>
        `;
        showModal(html);
        document.getElementById("saveStudentBtn").addEventListener("click", () => {
          student.listNumber = parseInt(document.getElementById("studentList").value);
          student.name = document.getElementById("studentName").value;
          student.teamId = document.getElementById("studentTeam").value;
          saveData();
          hideModal();
          updateStudentsTable();
        });
      }
      // Agregar alumno
      function openAddStudentModal() {
        let html = `
          <h3>Agregar Alumno</h3>
          <label>Número de Lista: <input type="number" id="studentList"></label><br>
          <label>Nombre: <input type="text" id="studentName"></label><br>
          <label>Materia: <select id="studentSubject"></select></label><br>
          <label>Equipo (ID): <input type="text" id="studentTeam"></label><br>
          <button id="addStudentConfirmBtn">Agregar</button>
        `;
        showModal(html);
        const subjectSelectInput = document.getElementById("studentSubject");
        for(let subjId in data.subjects) {
          const option = document.createElement("option");
          option.value = subjId;
          option.textContent = data.subjects[subjId].name;
          subjectSelectInput.appendChild(option);
        }
        document.getElementById("addStudentConfirmBtn").addEventListener("click", () => {
          const listNumber = parseInt(document.getElementById("studentList").value);
          const name = document.getElementById("studentName").value;
          const subjectId = document.getElementById("studentSubject").value;
          const teamId = document.getElementById("studentTeam").value;
          const newStudent = {
            id: "stud_" + Date.now(),
            listNumber: listNumber,
            name: name,
            subjectId: subjectId,
            teamId: teamId,
            partials: {
              "1": { grades: { exams:{}, tasks:{}, practices:{} }, extras: { extraParcial:0 }, deductions: [] },
              "2": { grades: { exams:{}, tasks:{}, practices:{} }, extras: { extraParcial:0 }, deductions: [] },
              "3": { grades: { exams:{}, tasks:{}, practices:{} }, extras: { extraParcial:0 }, deductions: [] },
              "4": { grades: { exams:{}, tasks:{}, practices:{} }, extras: { extraParcial:0 }, deductions: [] }
            }
          };
          data.students.push(newStudent);
          saveData();
          hideModal();
          updateStudentsTable();
        });
      }
      // Editar equipo
      function openEditTeamModal(teamId) {
        const subj = data.subjects[currentSubjectId];
        let team = null;
        subj.teams[currentPartial].forEach(t => { if(t.id === teamId) team = t; });
        if(!team) return;
        let html = `
          <h3>Editar Equipo</h3>
          <label>ID: <input type="text" id="teamId" value="${team.id}" disabled></label><br>
          <label>Nombre: <input type="text" id="teamName" value="${team.name}"></label><br>
          <label>Encargado: <input type="text" id="teamEncargado" value="${team.encargado}"></label><br>
          <button id="saveTeamBtn">Guardar</button>
        `;
        showModal(html);
        document.getElementById("saveTeamBtn").addEventListener("click", () => {
          team.name = document.getElementById("teamName").value;
          team.encargado = document.getElementById("teamEncargado").value;
          saveData();
          hideModal();
          updateTeamsTable();
        });
      }
      // Agregar equipo
      function openAddTeamModal() {
        let html = `
          <h3>Agregar Equipo</h3>
          <label>ID: <input type="text" id="teamId"></label><br>
          <label>Nombre: <input type="text" id="teamName"></label><br>
          <label>Encargado: <input type="text" id="teamEncargado"></label><br>
          <button id="addTeamConfirmBtn">Agregar</button>
        `;
        showModal(html);
        document.getElementById("addTeamConfirmBtn").addEventListener("click", () => {
          const id = document.getElementById("teamId").value;
          const name = document.getElementById("teamName").value;
          const encargado = document.getElementById("teamEncargado").value;
          if(currentSubjectId) {
            const subj = data.subjects[currentSubjectId];
            if(!subj.teams[currentPartial]) { subj.teams[currentPartial] = []; }
            subj.teams[currentPartial].push({ id, name, encargado, evaluations: { practices: [] } });
            saveData();
            hideModal();
            updateTeamsTable();
          }
        });
      }
      // Agregar deducción
      function openAddDeductionModal() {
        let html = `
          <h3>Agregar Deducción</h3>
          <label>Motivo: <input type="text" id="deductionMotivo"></label><br>
          <label>Fecha: <input type="date" id="deductionFecha"></label><br>
          <label>Cantidad: <input type="number" id="deductionCantidad"></label><br>
          <button id="addDeductionConfirmBtn">Agregar</button>
        `;
        showModal(html);
        document.getElementById("addDeductionConfirmBtn").addEventListener("click", () => {
          const motivo = document.getElementById("deductionMotivo").value;
          const fecha = document.getElementById("deductionFecha").value;
          const cantidad = parseFloat(document.getElementById("deductionCantidad").value);
          const student = data.students.find(s => s.subjectId === currentSubjectId);
          if(student) {
            if(!student.partials[currentPartial].deductions) { student.partials[currentPartial].deductions = []; }
            student.partials[currentPartial].deductions.push({ motivo, fecha, cantidad });
            saveData();
            hideModal();
            updateDeductionsTable();
            updateStudentsTable();
          } else { alert("No hay alumnos para asignar la deducción."); }
        });
      }
      
      // Funciones para eliminar elementos
      function deleteStudent(studentId) {
        if(confirm("¿Eliminar alumno?")) {
          data.students = data.students.filter(s => s.id !== studentId);
          saveData();
          updateStudentsTable();
        }
      }
      function deleteTeam(teamId) {
        if(confirm("¿Eliminar equipo?") && currentSubjectId) {
          const subj = data.subjects[currentSubjectId];
          subj.teams[currentPartial] = subj.teams[currentPartial].filter(t => t.id !== teamId);
          saveData();
          updateTeamsTable();
        }
      }
      function deleteDeduction(studentId, dedIndex) {
        const student = data.students.find(s => s.id === studentId);
        if(student) {
          student.partials[currentPartial].deductions.splice(dedIndex, 1);
          saveData();
          updateDeductionsTable();
          updateStudentsTable();
        }
      }
      
      /* ---------------------- FUNCIONES DE EXPORTACIÓN Y PRESENTACIÓN ---------------------- */
      function exportToExcel() {
        const wb = XLSX.utils.book_new();
        const ws_data = [];
        const headerRow = [];
        gradesHeader.querySelectorAll("th").forEach(th => headerRow.push(th.textContent));
        ws_data.push(headerRow);
        gradesBody.querySelectorAll("tr").forEach(tr => {
          const row = [];
          tr.querySelectorAll("td").forEach(td => row.push(td.textContent));
          ws_data.push(row);
        });
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Parcial " + currentPartial);
        XLSX.writeFile(wb, "Calificaciones_Parcial_" + currentPartial + ".xlsx");
      }
      
      function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape" });
        let y = 10;
        doc.setFontSize(12);
        doc.text("Calificaciones - Parcial " + currentPartial, 10, y);
        y += 10;
        let headers = [];
        gradesHeader.querySelectorAll("th").forEach(th => headers.push(th.textContent));
        doc.autoTable({
          head: [headers],
          body: [],
          startY: y,
          theme: 'grid'
        });
        const bodyData = [];
        gradesBody.querySelectorAll("tr").forEach(tr => {
          const row = [];
          tr.querySelectorAll("td").forEach(td => row.push(td.textContent));
          row.push("Firma: __________________");
          bodyData.push(row);
        });
        doc.autoTable({
          body: bodyData,
          startY: doc.lastAutoTable.finalY + 10,
          theme: 'grid'
        });
        doc.save("Calificaciones_Parcial_" + currentPartial + ".pdf");
      }
      
      function printPartial() { window.print(); }
      
      function shareVersion() {
        const url = new URL(window.location.href);
        url.searchParams.set("readonly", "true");
        url.searchParams.set("subject", currentSubjectId);
        url.searchParams.set("partial", currentPartial);
        prompt("Enlace para compartir:", url.toString());
      }
      
      /* ---------------------- EVENTOS DE LOS BOTONES DE LA INTERFAZ ---------------------- */
      addSubjectBtn.addEventListener("click", () => { openEditSubjectModal(); });
      addExamBtn.addEventListener("click", () => { openAddEvaluationModal("exam"); });
      addTaskBtn.addEventListener("click", () => { openAddEvaluationModal("task"); });
      addPracticeBtn.addEventListener("click", () => { openAddEvaluationModal("practice"); });
      addStudentBtn.addEventListener("click", () => { openAddStudentModal(); });
      addTeamBtn.addEventListener("click", () => { openAddTeamModal(); });
      addDeductionBtn.addEventListener("click", () => { openAddDeductionModal(); });
      exportExcelBtn.addEventListener("click", exportToExcel);
      exportPDFBtn.addEventListener("click", exportToPDF);
      printPartialBtn.addEventListener("click", printPartial);
      shareVersionBtn.addEventListener("click", shareVersion);
      
      subjectSelect.addEventListener("change", () => {
        currentSubjectId = subjectSelect.value;
        updateEvaluationsHeader();
        updateStudentsTable();
        updateTeamsTable();
        updateDeductionsTable();
      });
      partialSelect.addEventListener("change", () => {
        currentPartial = partialSelect.value;
        updateEvaluationsHeader();
        updateStudentsTable();
        updateTeamsTable();
        updateDeductionsTable();
      });
      
      /* ---------------------- AUTENTICACIÓN CON FIREBASE ---------------------- */
      if(!readOnly) {
        auth.onAuthStateChanged(user => {
          if(user) {
            currentUser = user;
            updateEditMode();
          } else {
            currentUser = null;
            updateEditMode();
            loginModal.style.display = "block";
          }
        });
        loginSubmitBtn.addEventListener("click", () => {
          const email = loginEmail.value;
          const password = loginPassword.value;
          auth.signInWithEmailAndPassword(email, password)
            .then(cred => {
              currentUser = cred.user;
              loginModal.style.display = "none";
              updateEditMode();
            })
            .catch(err => { alert("Error de autenticación: " + err.message); });
        });
      }
      
      /* ---------------------- INICIALIZACIÓN ---------------------- */
      loadData();
      updateSubjectSelector();
      updateSubjectsList();
      updateEvaluationsHeader();
      updateStudentsTable();
      updateTeamsTable();
      updateDeductionsTable();
      updateEditMode();
    });
  </script>
</body>
</html>
