<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Sistema de Calificaciones - Institución XYZ</title>
  <style>
    /* ===== ESTILOS GENERALES Y RESPONSIVOS ===== */
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom, #cce0ff, #e6e6e6);
      margin: 0;
      padding: 0;
      color: #333;
    }
    .container {
      background: #fff;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 1400px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
    }
    header {
      border-bottom: 2px solid #003366;
      margin-bottom: 20px;
      padding-bottom: 10px;
    }
    header h1 {
      text-align: center;
      color: #003366;
      margin: 0;
      font-size: 2em;
    }
    .header-controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .subject-select label,
    .rubric-display { font-weight: bold; }
    /* Se incluye botones para agregar y editar materia y para compartir versión */
    .subject-select select { margin-right: 5px; }
    .subject-select button { margin-right: 5px; padding: 5px 10px; font-size: 0.9em; }
    .partial-tabs button {
      background: #0056b3;
      color: #fff;
      border: none;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .partial-tabs button.active,
    .partial-tabs button:hover { background: #003d80; }
    .rubric-display button,
    .cred-btn {
      margin-left: 10px;
      padding: 5px 10px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    main { padding: 10px 0; }
    .eval-controls, .student-controls, .action-section {
      text-align: center;
      margin: 15px 0;
    }
    .btn {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 8px 12px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn:hover { background: #0056b3; }
    /* ===== TABLAS ===== */
    .table-container {
      overflow-x: auto;
      background: #fff;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }
    table, th, td { border: 1px solid #ccc; }
    th {
      background: #003366;
      color: #fff;
      padding: 10px;
      text-align: center;
      white-space: nowrap;
    }
    td {
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }
    td input, td select {
      padding: 4px;
      text-align: center;
      border: 1px solid #aaa;
      border-radius: 3px;
    }
    /* ===== RESALTAR COLUMNAS PRINCIPALES ===== */
    .exam-average, .task-average, .practice-average, .total-partial {
      background-color: #d1e7dd;
    }
    /* ===== REGLAS PARA IMPRESIÓN Y PDF ===== */
    @media print {
      body { background: #fff; }
      .container { box-shadow: none; }
      .table-container { overflow: visible; }
      /* Se añaden líneas de firma debajo de cada celda */
      td::after {
        content: "";
        display: block;
        border-bottom: 1px dashed #000;
        margin-top: 5px;
      }
      @page { size: A4 landscape; margin: 20mm; }
    }
    /* ===== MODAL ===== */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      position: relative;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #333;
    }
    /* ===== LOGIN MODAL ===== */
    #loginModal .modal-content { max-width: 400px; }
    #loginModal h2 { margin-top: 0; text-align: center; }
    #loginModal input { width: 100%; padding: 8px; margin: 10px 0; }
    /* ===== PIE DE PÁGINA ===== */
    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.8em;
      color: #555;
    }
    /* ===== RESPONSIVIDAD ===== */
    @media (max-width: 768px) {
      .container { margin: 10px; padding: 10px; }
      header h1 { font-size: 1.5em; }
      .partial-tabs button { padding: 6px 10px; font-size: 0.9em; }
      th, td { font-size: 0.8em; padding: 6px; }
      .btn, .cred-btn { padding: 6px 10px; font-size: 0.8em; }
    }
  </style>
</head>
<body>
  <!-- Modal de Login -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2>Iniciar Sesión</h2>
      <label>Usuario:</label>
      <input type="text" id="loginUser" placeholder="Ingrese usuario">
      <label>Contraseña:</label>
      <input type="password" id="loginPass" placeholder="Ingrese contraseña">
      <button id="loginBtn" class="btn">Acceder</button>
      <button id="configCred" class="cred-btn">Configurar Credenciales</button>
      <p style="text-align:center; font-size:0.8em; margin-top:10px;">Creada y diseñada por Francisco López Velázquez</p>
    </div>
  </div>

  <!-- Contenedor principal (visible tras login) -->
  <div class="container" id="appContainer" style="display:none;">
    <header>
      <h1>Sistema de Calificaciones</h1>
      <div class="header-controls">
        <div class="subject-select">
          <label for="subjectSelect">Materia:</label>
          <select id="subjectSelect"></select>
          <button id="addSubject" class="cred-btn">Agregar Materia</button>
          <button id="editSubject" class="cred-btn">Editar Materia</button>
          <button id="shareVersion" class="cred-btn">Compartir Versión</button>
        </div>
        <div class="partial-tabs">
          <button class="tab-btn active" data-partial="1">Parcial 1</button>
          <button class="tab-btn" data-partial="2">Parcial 2</button>
          <button class="tab-btn" data-partial="3">Parcial 3</button>
          <button class="tab-btn" data-partial="4">Parcial 4</button>
        </div>
        <div class="rubric-display">
          Rúbrica: Exámenes: <span id="weightExam">45%</span>, Tareas: <span id="weightTask">25%</span>, Prácticas: <span id="weightPractice">30%</span>, Participación: <span id="weightPart">5%</span>
          <button id="editRubric" class="btn">Editar Rúbrica</button>
        </div>
      </div>
    </header>
    
    <main>
      <!-- Controles para agregar evaluaciones -->
      <section class="eval-controls">
        <button id="addExamEval" class="btn">Agregar Ex</button>
        <button id="addTaskEval" class="btn">Agregar Ta</button>
        <button id="addPracticeEval" class="btn">Agregar Pr</button>
      </section>
      <!-- Administración de alumnos -->
      <section class="student-controls">
        <button id="addStudent" class="btn">Agregar Alumno</button>
      </section>
      <!-- Tabla de equipos (prácticas) -->
      <section class="team-section">
        <h2>Equipos (Prácticas)</h2>
        <div class="table-container">
          <button id="addTeam" class="btn">Agregar Equipo</button>
          <table id="teamTable">
            <thead id="teamHeader"></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <!-- Tabla principal de calificaciones -->
      <section class="grade-section">
        <h2>Calificaciones - Parcial <span id="currentPartialDisplay">1</span></h2>
        <div class="table-container">
          <table id="gradeTable">
            <thead>
              <tr id="groupHeaderRow">
                <th rowspan="2">N° LS</th>
                <th rowspan="2">Alumno</th>
                <th rowspan="2">Equipo</th>
                <th class="exam-group" colspan="0">Exámenes</th>
                <th class="task-group" colspan="0">Tareas</th>
                <th class="practice-group" colspan="0">Prácticas</th>
                <th rowspan="2">Extra Ex.</th>
                <th rowspan="2">Extra Ta.</th>
                <th rowspan="2">Extra Pr.</th>
                <th rowspan="2">Extra Parcial</th>
                <th rowspan="2">Extra Total</th>
                <th rowspan="2">Participación (5%)</th>
                <th rowspan="2">Faltas</th>
                <th rowspan="2">Deducciones</th>
                <th rowspan="2">Total Parcial</th>
                <th rowspan="2">Acciones</th>
              </tr>
              <tr id="dynamicHeader"></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <!-- Botones de acción -->
      <section class="action-section">
        <button id="exportExcel" class="btn">Exportar Excel</button>
        <button id="exportPDF" class="btn">Exportar PDF</button>
        <button id="printGrades" class="btn">Imprimir Parcial</button>
      </section>
    </main>
    <footer>Pagina creada y diseñada por Francisco López Velázquez</footer>
  </div>
  
  <!-- Modal General (para editar rúbrica, materia, agregar alumno, equipo, deducciones, etc.) -->
  <div id="modalOverlay" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>
  
  <!-- ===== SCRIPTS: jsPDF, autoTable y código principal ===== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    /***********************
     * VARIABLES Y CONFIGURACIÓN
     ***********************/
    let isLoggedIn = false;
    let readOnlyMode = (new URLSearchParams(window.location.search)).get("readonly") === "true";
    let currentSubject = "circuitos";
    let currentPartial = 1;
    
    // Configuración de materias (cada materia incluye nombre, semestre y año)
    const subjectsConfig = {
      circuitos: {
        name: "Circuitos Eléctricos",
        semester: "ene-jul",
        year: 2023,
        rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
        examEvals: [],
        taskEvals: [],
        practiceEvals: []
      },
      tt6: {
        name: "TT6",
        semester: "ene-jul",
        year: 2023,
        rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
        examEvals: [],
        taskEvals: [],
        practiceEvals: []
      },
      instalaciones: {
        name: "Instalaciones y Control Eléctrico",
        semester: "ago-dic",
        year: 2023,
        rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
        examEvals: [],
        taskEvals: [],
        practiceEvals: []
      },
      fisica4: {
        name: "Física 4",
        semester: "ago-dic",
        year: 2023,
        rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
        examEvals: [],
        taskEvals: [],
        practiceEvals: []
      }
    };
    
    // Función para recargar el selector de materias
    function buildSubjectSelect() {
      const select = document.getElementById("subjectSelect");
      select.innerHTML = "";
      for (let key in subjectsConfig) {
        const subj = subjectsConfig[key];
        const option = document.createElement("option");
        option.value = key;
        option.textContent = `${subj.name} (${subj.semester}, ${subj.year})`;
        select.appendChild(option);
      }
      select.value = currentSubject;
    }
    
    // Alumnos: cada alumno tiene número de lista, nombre, equipo, materia y registros por parcial
    const students = [
      { listNumber: 1, name: "Juan Pérez", team: "E1", subject: "circuitos", partials: {} },
      { listNumber: 2, name: "María García", team: "E2", subject: "circuitos", partials: {} },
      { listNumber: 3, name: "Carlos López", team: "E1", subject: "tt6", partials: {} }
    ];
    
    // Equipos por materia: cada equipo tendrá un registro de prácticas por parcial
    const teams = {
      circuitos: [
        { id: "E1", name: "Equipo E1", head: "Encargado 1", partials: {} },
        { id: "E2", name: "Equipo E2", head: "Encargado 2", partials: {} }
      ],
      tt6: [
        { id: "E1", name: "Equipo A", head: "Encargado A", partials: {} },
        { id: "E2", name: "Equipo B", head: "Encargado B", partials: {} }
      ],
      instalaciones: [
        { id: "E1", name: "Equipo X", head: "Encargado X", partials: {} },
        { id: "E2", name: "Equipo Y", head: "Encargado Y", partials: {} }
      ],
      fisica4: [
        { id: "E1", name: "Equipo F1", head: "Encargado F1", partials: {} },
        { id: "E2", name: "Equipo F2", head: "Encargado F2", partials: {} }
      ]
    };
    
    /***********************
     * FUNCIONES UTILITARIAS
     ***********************/
    function getCurrentSubjectConfig() { return subjectsConfig[currentSubject]; }
    function updateRubricDisplay() {
      const cfg = getCurrentSubjectConfig();
      document.getElementById("weightExam").textContent = cfg.rubric.exam + "%";
      document.getElementById("weightTask").textContent = cfg.rubric.task + "%";
      document.getElementById("weightPractice").textContent = cfg.rubric.practice + "%";
      document.getElementById("weightPart").textContent = cfg.rubric.participation + "%";
    }
    function updatePartialDisplay() { document.getElementById("currentPartialDisplay").textContent = currentPartial; }
    
    /***********************
     * ENCABEZADO DE TABLA (Página Web)
     ***********************/
    function buildGroupHeader() {
      const cfg = getCurrentSubjectConfig();
      const examColspan = cfg.examEvals.length + 1;
      const taskColspan = cfg.taskEvals.length + 1;
      const practiceColspan = cfg.practiceEvals.length + 1;
      document.querySelector(".exam-group").setAttribute("colspan", examColspan);
      document.querySelector(".task-group").setAttribute("colspan", taskColspan);
      document.querySelector(".practice-group").setAttribute("colspan", practiceColspan);
    }
    function buildDynamicHeader() {
      const headerRow = document.getElementById("dynamicHeader");
      headerRow.innerHTML = "";
      const cfg = getCurrentSubjectConfig();
      cfg.examEvals.forEach(evalObj => {
        const th = document.createElement("th");
        th.textContent = evalObj.name;
        headerRow.appendChild(th);
      });
      const thExamAvg = document.createElement("th");
      thExamAvg.textContent = "Promedio Exámenes";
      headerRow.appendChild(thExamAvg);
      cfg.taskEvals.forEach(evalObj => {
        const th = document.createElement("th");
        th.textContent = evalObj.name;
        headerRow.appendChild(th);
      });
      const thTaskAvg = document.createElement("th");
      thTaskAvg.textContent = "Promedio Tareas";
      headerRow.appendChild(thTaskAvg);
      cfg.practiceEvals.forEach(evalObj => {
        const th = document.createElement("th");
        th.textContent = evalObj.name;
        headerRow.appendChild(th);
      });
      const thPracticeAvg = document.createElement("th");
      thPracticeAvg.textContent = "Promedio Prácticas";
      headerRow.appendChild(thPracticeAvg);
      buildGroupHeader();
    }
    
    /***********************
     * TABLA DE EQUIPOS (PRÁCTICAS) – REGISTROS POR PARCIAL
     ***********************/
    function buildTeamTable() {
      const teamTableHead = document.getElementById("teamHeader");
      const teamTableBody = document.querySelector("#teamTable tbody");
      teamTableHead.innerHTML = "";
      teamTableBody.innerHTML = "";
      const cfg = getCurrentSubjectConfig();
      let headerHTML = "<tr><th>Equipo</th><th>Encargado</th>";
      cfg.practiceEvals.forEach((evalObj, index) => { headerHTML += `<th>${evalObj.name}</th>`; });
      headerHTML += "<th>Acciones</th></tr>";
      teamTableHead.innerHTML = headerHTML;
      const subjectTeams = teams[currentSubject] || [];
      subjectTeams.forEach(team => {
        // Usar registros de prácticas por parcial
        if (!team.partials) team.partials = {};
        if (!team.partials[currentPartial]) {
          team.partials[currentPartial] = Array(cfg.practiceEvals.length).fill(0);
        }
        let rowHTML = `<tr data-team-id="${team.id}"><td>${team.name}</td><td>${team.head}</td>`;
        team.partials[currentPartial].forEach((val, idx) => {
          rowHTML += `<td><input type="number" class="team-practice-input" data-team-id="${team.id}" data-index="${idx}" min="0" max="10" step="0.1" value="${val}"></td>`;
        });
        rowHTML += `<td><button class="edit-team btn">Editar</button></td></tr>`;
        teamTableBody.innerHTML += rowHTML;
      });
      document.querySelectorAll(".team-practice-input").forEach(input => {
        input.addEventListener("input", (e) => {
          const teamId = e.target.getAttribute("data-team-id");
          const idx = parseInt(e.target.getAttribute("data-index"));
          const newVal = parseFloat(e.target.value) || 0;
          const subjectTeams = teams[currentSubject];
          const team = subjectTeams.find(t => t.id === teamId);
          if(team) {
            if (!team.partials) team.partials = {};
            if (!team.partials[currentPartial]) team.partials[currentPartial] = Array(getCurrentSubjectConfig().practiceEvals.length).fill(0);
            team.partials[currentPartial][idx] = newVal;
            document.querySelectorAll("#gradeTable tbody tr").forEach(row => {
              const stuTeamSelect = row.querySelector(".student-team");
              const stuTeam = stuTeamSelect ? stuTeamSelect.value : "";
              if(stuTeam === teamId) {
                const practiceInputs = row.querySelectorAll(".practice-input");
                if(practiceInputs[idx]) { practiceInputs[idx].value = newVal; recalculateRow(row); }
              }
            });
          }
        });
      });
      // Editar equipo: botón "Editar" en cada fila de equipo
      document.querySelectorAll(".edit-team").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const row = e.target.closest("tr");
          const teamId = row.getAttribute("data-team-id");
          const subjectTeams = teams[currentSubject];
          const team = subjectTeams.find(t => t.id === teamId);
          if(team) {
            let content = `
              <h3>Editar Equipo</h3>
              <label>Nombre: <input type="text" id="editTeamName" value="${team.name}"></label><br>
              <label>Encargado: <input type="text" id="editTeamHead" value="${team.head}"></label><br>
              <button id="saveTeam" class="btn">Guardar</button>
            `;
            showModal(content);
            document.getElementById("saveTeam").addEventListener("click", () => {
              team.name = document.getElementById("editTeamName").value.trim();
              team.head = document.getElementById("editTeamHead").value.trim();
              modal.style.display = "none";
              buildTeamTable();
              buildGradeTable(); // Para actualizar la columna de equipo en la tabla de calificaciones
            });
          }
        });
      });
    }
    
    /***********************
     * TABLA DE CALIFICACIONES (ALUMNOS)
     ***********************/
    function buildGradeTable() {
      const tbody = document.querySelector("#gradeTable tbody");
      tbody.innerHTML = "";
      const cfg = getCurrentSubjectConfig();
      const filteredStudents = students.filter(s => s.subject === currentSubject);
      filteredStudents.forEach(student => {
        if (!student.partials[currentPartial]) {
          student.partials[currentPartial] = {
            exams: Array(cfg.examEvals.length).fill(0),
            tasks: Array(cfg.taskEvals.length).fill(0),
            practices: Array(cfg.practiceEvals.length).fill(0),
            extraExam: 0,
            extraTask: 0,
            extraPractice: 0,
            extraPartial: 0,
            participation: 0,
            absences: 0,
            deductions: [],
            total: 0
          };
        } else {
          while (student.partials[currentPartial].exams.length < cfg.examEvals.length) { student.partials[currentPartial].exams.push(0); }
          while (student.partials[currentPartial].tasks.length < cfg.taskEvals.length) { student.partials[currentPartial].tasks.push(0); }
          while (student.partials[currentPartial].practices.length < cfg.practiceEvals.length) { student.partials[currentPartial].practices.push(0); }
          if (student.partials[currentPartial].extraPartial === undefined) { student.partials[currentPartial].extraPartial = 0; }
          if (!student.partials[currentPartial].deductions) { student.partials[currentPartial].deductions = []; }
        }
        const partialData = student.partials[currentPartial];
        let rowHTML = `<tr data-list="${student.listNumber}">
          <td>${student.listNumber}</td>
          <td contenteditable="true" class="student-name">${student.name}</td>
          <td>
            <select class="student-team">
              ${teams[currentSubject].map(team => `<option value="${team.id}" ${team.id === student.team ? "selected" : ""}>${team.name}</option>`).join('')}
            </select>
          </td>`;
        cfg.examEvals.forEach((evalObj, index) => {
          const val = partialData.exams[index] || 0;
          rowHTML += `<td><input type="number" class="exam-input" data-index="${index}" min="0" max="10" step="0.1" value="${val}"></td>`;
        });
        rowHTML += `<td class="exam-average">0</td>`;
        cfg.taskEvals.forEach((evalObj, index) => {
          const val = partialData.tasks[index] || 0;
          rowHTML += `<td><input type="number" class="task-input" data-index="${index}" min="0" max="10" step="0.1" value="${val}"></td>`;
        });
        rowHTML += `<td class="task-average">0</td>`;
        cfg.practiceEvals.forEach((evalObj, index) => {
          const subjectTeams = teams[currentSubject];
          const teamObj = subjectTeams.find(t => t.id === student.team);
          let grade = 0;
          if(teamObj && teamObj.partials && teamObj.partials[currentPartial] && teamObj.partials[currentPartial][index] !== undefined) { 
            grade = teamObj.partials[currentPartial][index]; 
          }
          partialData.practices[index] = grade;
          rowHTML += `<td><input type="number" class="practice-input" data-index="${index}" min="0" max="10" step="0.1" value="${grade}" readonly></td>`;
        });
        rowHTML += `<td class="practice-average">0</td>`;
        // Extras: reordenados: Extra Ex, Extra Ta, Extra Pr, Extra Parcial, Extra Total, Participación, Faltas, Deducciones, Total Parcial, Acciones
        rowHTML += `
          <td><input type="number" class="extra-exam" min="0" max="2" step="0.1" value="${partialData.extraExam}"></td>
          <td><input type="number" class="extra-task" min="0" max="2" step="0.1" value="${partialData.extraTask}"></td>
          <td><input type="number" class="extra-practice" min="0" max="2" step="0.1" value="${partialData.extraPractice}"></td>
          <td><input type="number" class="extra-parcial" min="0" step="0.1" value="${partialData.extraPartial}"></td>
          <td class="extra-total">0</td>
          <td><input type="number" class="participation" min="0" max="5" step="0.1" value="${partialData.participation}"></td>
          <td><input type="number" class="absences" min="0" step="1" value="${partialData.absences}"></td>
          <td class="deductions"><span class="deduction-sum">0</span> <button class="deduct-btn btn">Ded</button></td>
          <td class="total-partial">0</td>
          <td><button class="row-action-btn btn">Ver Deducciones</button></td>
        </tr>`;
        tbody.innerHTML += rowHTML;
      });
      attachTableListeners();
      recalculateAll();
      if(readOnlyMode) { setReadOnly(); }
    }
    
    /***********************
     * CÁLCULOS DE CALIFICACIONES (incluye deducciones)
     ***********************/
    function recalculateRow(row) {
      const rubric = getCurrentSubjectConfig().rubric;
      let examSum = 0, examCount = 0;
      row.querySelectorAll(".exam-input").forEach(input => { examSum += parseFloat(input.value) || 0; examCount++; });
      const examAvg = examCount ? examSum / examCount : 0;
      row.querySelector(".exam-average").textContent = examAvg.toFixed(2);
      let taskSum = 0, taskCount = 0;
      row.querySelectorAll(".task-input").forEach(input => { taskSum += parseFloat(input.value) || 0; taskCount++; });
      const taskAvg = taskCount ? taskSum / taskCount : 0;
      row.querySelector(".task-average").textContent = taskAvg.toFixed(2);
      let practiceSum = 0, practiceCount = 0;
      row.querySelectorAll(".practice-input").forEach(input => { practiceSum += parseFloat(input.value) || 0; practiceCount++; });
      const practiceAvg = practiceCount ? practiceSum / practiceCount : 0;
      row.querySelector(".practice-average").textContent = practiceAvg.toFixed(2);
      const extraExam = parseFloat(row.querySelector(".extra-exam").value) || 0;
      const extraTask = parseFloat(row.querySelector(".extra-task").value) || 0;
      const extraPractice = parseFloat(row.querySelector(".extra-practice").value) || 0;
      const extraParcial = parseFloat(row.querySelector(".extra-parcial").value) || 0;
      // Extra Total = suma de (Extra Ex, Ta, Pr) + Extra Parcial
      const extraTotal = (extraExam * rubric.exam/100) + (extraTask * rubric.task/100) + (extraPractice * rubric.practice/100) + extraParcial;
      row.querySelector(".extra-total").textContent = extraTotal.toFixed(2);
      const participation = parseFloat(row.querySelector(".participation").value) || 0;
      // Deducciones: sumar valores en deductions array del alumno
      const listNum = row.getAttribute("data-list");
      const student = students.find(s => s.listNumber == listNum);
      let deductionSum = 0;
      if(student && student.partials[currentPartial].deductions) {
        deductionSum = student.partials[currentPartial].deductions.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
      }
      row.querySelector(".deduction-sum").textContent = deductionSum.toFixed(2);
      // Total Parcial = (promedios ponderados + extras + participación) - deducciones - (falta, se puede incluir si se quiere)
      const baseTotal = (examAvg * rubric.exam/100) + (taskAvg * rubric.task/100) + (practiceAvg * rubric.practice/100) + extraTotal + (participation * rubric.participation/100);
      const totalPartial = baseTotal - deductionSum - (parseFloat(row.querySelector(".absences").value) || 0);
      row.querySelector(".total-partial").textContent = totalPartial.toFixed(2);
      if(student) { student.partials[currentPartial].total = totalPartial; }
    }
    function recalculateAll() { document.querySelectorAll("#gradeTable tbody tr").forEach(row => recalculateRow(row)); }
    
    /***********************
     * EVENTOS DE LA TABLA
     ***********************/
    function attachTableListeners() {
      document.querySelectorAll("#gradeTable tbody input").forEach(input => {
        input.addEventListener("input", () => { 
          const row = input.closest("tr");
          saveRowData(row);
          recalculateRow(row);
        });
      });
      document.querySelectorAll(".student-team").forEach(select => {
        select.addEventListener("change", (e) => {
          const row = e.target.closest("tr");
          const listNum = row.getAttribute("data-list");
          const student = students.find(s => s.listNumber == listNum);
          if(student) { student.team = e.target.value; }
          propagateTeamGradeForRow(row);
        });
      });
      document.querySelectorAll(".student-name").forEach(cell => {
        cell.addEventListener("blur", (e) => {
          const row = e.target.closest("tr");
          const listNum = row.getAttribute("data-list");
          const student = students.find(s => s.listNumber == listNum);
          if(student) { student.name = e.target.textContent.trim(); }
        });
      });
      // Botón Ded: para agregar deducciones
      document.querySelectorAll(".deduct-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const row = e.target.closest("tr");
          const listNum = row.getAttribute("data-list");
          const student = students.find(s => s.listNumber == listNum);
          if(student) { openDeductionModal(student); }
        });
      });
      // Botón de acciones (ver detalle de deducciones)
      document.querySelectorAll(".row-action-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const row = e.target.closest("tr");
          const listNum = row.getAttribute("data-list");
          const student = students.find(s => s.listNumber == listNum);
          if(student) { openDeductionModal(student, true); }
        });
      });
    }
    function saveRowData(row) {
      const listNum = row.getAttribute("data-list");
      const student = students.find(s => s.listNumber == listNum);
      if(!student) return;
      const partialData = student.partials[currentPartial];
      partialData.exams = [];
      row.querySelectorAll(".exam-input").forEach(input => { partialData.exams.push(parseFloat(input.value) || 0); });
      partialData.tasks = [];
      row.querySelectorAll(".task-input").forEach(input => { partialData.tasks.push(parseFloat(input.value) || 0); });
      partialData.extraExam = parseFloat(row.querySelector(".extra-exam").value) || 0;
      partialData.extraTask = parseFloat(row.querySelector(".extra-task").value) || 0;
      partialData.extraPractice = parseFloat(row.querySelector(".extra-practice").value) || 0;
      partialData.extraPartial = parseFloat(row.querySelector(".extra-parcial").value) || 0;
      partialData.participation = parseFloat(row.querySelector(".participation").value) || 0;
      partialData.absences = parseFloat(row.querySelector(".absences").value) || 0;
    }
    function propagateTeamGradeForRow(row) {
      const listNum = row.getAttribute("data-list");
      const student = students.find(s => s.listNumber == listNum);
      if(!student) return;
      const subjectTeams = teams[currentSubject];
      const teamObj = subjectTeams.find(t => t.id === student.team);
      if(teamObj && teamObj.partials && teamObj.partials[currentPartial]) {
        row.querySelectorAll(".practice-input").forEach((input, idx) => { input.value = teamObj.partials[currentPartial][idx] || 0; });
      }
      recalculateRow(row);
    }
    
    /***********************
     * MODALES: DEDUCCIONES, EDITAR MATERIA, ETC.
     ***********************/
    function openDeductionModal(student, viewOnly = false) {
      // Permite agregar o ver deducciones para el alumno en el parcial actual
      let content = `<h3>Deducciones para ${student.name}</h3>`;
      content += `<label>Monto (-): <input type="number" id="dedAmount" step="0.1"></label><br>`;
      content += `<label>Motivo: <input type="text" id="dedReason"></label><br>`;
      content += `<label>Fecha: <input type="date" id="dedDate"></label><br>`;
      if(!viewOnly) { content += `<button id="saveDed" class="btn">Agregar Deducción</button>`; }
      if(student.partials[currentPartial].deductions && student.partials[currentPartial].deductions.length > 0) {
        content += `<h4>Deducciones Registradas:</h4><ul>`;
        student.partials[currentPartial].deductions.forEach((ded, i) => {
          content += `<li>${ded.date} - ${ded.reason}: ${ded.amount} pts</li>`;
        });
        content += `</ul>`;
      } else {
        content += `<p>No hay deducciones registradas.</p>`;
      }
      showModal(content);
      if(!viewOnly) {
        document.getElementById("saveDed").addEventListener("click", () => {
          const amount = parseFloat(document.getElementById("dedAmount").value) || 0;
          const reason = document.getElementById("dedReason").value.trim();
          const date = document.getElementById("dedDate").value;
          if(amount <= 0 || !reason || !date) { alert("Complete todos los campos."); return; }
          if(!student.partials[currentPartial].deductions) student.partials[currentPartial].deductions = [];
          student.partials[currentPartial].deductions.push({ amount, reason, date });
          modal.style.display = "none";
          buildGradeTable();
        });
      }
    }
    
    // Editar materia (el título y características)
    document.getElementById("editSubject").addEventListener("click", () => {
      const subj = subjectsConfig[currentSubject];
      let content = `<h3>Editar Materia</h3>
        <label>Nombre: <input type="text" id="editSubjName" value="${subj.name}"></label><br>
        <label>Semestre: 
          <select id="editSubjSemester">
            <option value="ene-jul" ${subj.semester === "ene-jul" ? "selected" : ""}>ene-jul</option>
            <option value="ago-dic" ${subj.semester === "ago-dic" ? "selected" : ""}>ago-dic</option>
          </select>
        </label><br>
        <label>Año: <input type="number" id="editSubjYear" value="${subj.year}"></label><br>
        <button id="saveSubjectEd" class="btn">Guardar</button>`;
      showModal(content);
      document.getElementById("saveSubjectEd").addEventListener("click", () => {
        subj.name = document.getElementById("editSubjName").value.trim();
        subj.semester = document.getElementById("editSubjSemester").value;
        subj.year = parseInt(document.getElementById("editSubjYear").value);
        modal.style.display = "none";
        buildSubjectSelect();
        buildDynamicHeader();
      });
    });
    
    // Agregar materia
    document.getElementById("addSubject").addEventListener("click", () => {
      let content = `<h3>Agregar Materia</h3>
        <label>ID: <input type="text" id="newSubjectId"></label><br>
        <label>Nombre: <input type="text" id="newSubjectName"></label><br>
        <label>Semestre: 
          <select id="newSubjectSemester">
            <option value="ene-jul">ene-jul</option>
            <option value="ago-dic">ago-dic</option>
          </select>
        </label><br>
        <label>Año: <input type="number" id="newSubjectYear" value="2023"></label><br>
        <button id="saveSubject" class="btn">Guardar Materia</button>`;
      showModal(content);
      document.getElementById("saveSubject").addEventListener("click", () => {
        const id = document.getElementById("newSubjectId").value.trim();
        const name = document.getElementById("newSubjectName").value.trim();
        const semester = document.getElementById("newSubjectSemester").value;
        const year = parseInt(document.getElementById("newSubjectYear").value);
        if(!id || !name || !semester || isNaN(year)) { alert("Complete todos los campos."); return; }
        subjectsConfig[id] = {
          name: name,
          semester: semester,
          year: year,
          rubric: { exam: 45, task: 25, practice: 30, participation: 5 },
          examEvals: [],
          taskEvals: [],
          practiceEvals: []
        };
        teams[id] = [];  // Inicializamos equipos para la nueva materia
        buildSubjectSelect();
        modal.style.display = "none";
      });
    });
    
    // Compartir versión de solo lectura
    document.getElementById("shareVersion").addEventListener("click", () => {
      // Abrir una nueva ventana con el parámetro ?readonly=true
      const url = new URL(window.location.href);
      url.searchParams.set("readonly", "true");
      window.open(url.toString(), "_blank");
    });
    
    /***********************
     * CONFIGURAR CREDENCIALES
     ***********************/
    document.getElementById("configCred").addEventListener("click", () => {
      let content = `<h3>Configurar Credenciales</h3>
        <label>Usuario:</label>
        <input type="text" id="newUser" value="${localStorage.getItem("appUser") || "admin"}"><br>
        <label>Contraseña:</label>
        <input type="password" id="newPass" value="${localStorage.getItem("appPass") || "admin123"}"><br>
        <button id="saveCred" class="btn">Guardar Credenciales</button>`;
      showModal(content);
      document.getElementById("saveCred").addEventListener("click", () => {
        const newUser = document.getElementById("newUser").value.trim();
        const newPass = document.getElementById("newPass").value;
        if(!newUser || !newPass) { alert("Complete ambos campos."); return; }
        localStorage.setItem("appUser", newUser);
        localStorage.setItem("appPass", newPass);
        alert("Credenciales actualizadas");
        modal.style.display = "none";
      });
    });
    
    /***********************
     * EVALUACIONES DINÁMICAS
     ***********************/
    document.getElementById("addExamEval").addEventListener("click", () => {
      const name = prompt("Nombre del nuevo Ex:", "Ex #" + (getCurrentSubjectConfig().examEvals.length + 1));
      if(name) { getCurrentSubjectConfig().examEvals.push({ name }); buildDynamicHeader(); buildGradeTable(); }
    });
    document.getElementById("addTaskEval").addEventListener("click", () => {
      const name = prompt("Nombre de la nueva Ta:", "Ta #" + (getCurrentSubjectConfig().taskEvals.length + 1));
      if(name) { getCurrentSubjectConfig().taskEvals.push({ name }); buildDynamicHeader(); buildGradeTable(); }
    });
    document.getElementById("addPracticeEval").addEventListener("click", () => {
      const name = prompt("Nombre de la nueva Pr:", "Pr #" + (getCurrentSubjectConfig().practiceEvals.length + 1));
      if(name) {
        getCurrentSubjectConfig().practiceEvals.push({ name });
        // Para cada equipo de la materia actual, en el parcial actual, agregar un espacio para la nueva práctica
        teams[currentSubject].forEach(team => {
          if (!team.partials) team.partials = {};
          if (!team.partials[currentPartial]) { 
            team.partials[currentPartial] = Array(getCurrentSubjectConfig().practiceEvals.length - 1).fill(0);
          }
          team.partials[currentPartial].push(0);
        });
        buildDynamicHeader();
        buildTeamTable();
        buildGradeTable();
      }
    });
    
    /***********************
     * EXPORTAR A EXCEL
     ***********************/
    document.getElementById("exportExcel").addEventListener("click", () => {
      const tableHTML = document.getElementById("gradeTable").outerHTML;
      const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
          <!--[if gte mso 9]><xml>
          <x:ExcelWorkbook>
          <x:ExcelWorksheets>
            <x:ExcelWorksheet>
              <x:Name>Calificaciones</x:Name>
              <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
            </x:ExcelWorksheet>
          </x:ExcelWorksheets>
          </x:ExcelWorkbook>
          </xml><![endif]-->
          <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
          <style>
            .exam-average, .task-average, .practice-average, .total-partial { background-color: #d1e7dd; }
            table, th, td { border: 1px solid #ccc; }
            th { background: #003366; color: #fff; }
          </style>
        </head>
        <body>
          ${tableHTML}
        </body>
        </html>
      `;
      const blob = new Blob([html], { type: "application/vnd.ms-excel" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "calificaciones_" + currentSubject + "_parcial_" + currentPartial + ".xls";
      a.click();
      URL.revokeObjectURL(url);
    });
    
    /***********************
     * EXPORTAR A PDF
     ***********************/
    document.getElementById("exportPDF").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'pt', 'a4');
      doc.setFontSize(10);
      doc.text("Calificaciones - " + subjectsConfig[currentSubject].name + " - Parcial " + currentPartial, 40, 30);
      // Encabezado compacto para PDF (usando acrónimos) y se incluyen todas las evaluaciones individuales
      const headerCells = [
        "N° LS", "Alumno", "Equipo"
      ];
      const cfg = getCurrentSubjectConfig();
      cfg.examEvals.forEach(e => headerCells.push(e.name));
      headerCells.push("P-EX");
      cfg.taskEvals.forEach(e => headerCells.push(e.name));
      headerCells.push("P-TA");
      cfg.practiceEvals.forEach(e => headerCells.push(e.name));
      headerCells.push("P-PR");
      headerCells.push("ExE");
      headerCells.push("ExT");
      headerCells.push("ExP");
      headerCells.push("ExP-Gen"); // Extra Parcial
      headerCells.push("ExTOT");
      headerCells.push("Par");
      headerCells.push("Faltas");
      headerCells.push("Ded");
      headerCells.push("TOT");
      headerCells.push("Firma");
      const headers = [headerCells];
      const data = [];
      document.querySelectorAll("#gradeTable tbody tr").forEach(row => {
        const rowData = [];
        const cells = Array.from(row.querySelectorAll("td"));
        // Omitir la última columna de acciones
        cells.slice(0, cells.length - 1).forEach((cell, index) => {
          const input = cell.querySelector("input, select");
          if(input) {
            if(input.tagName.toLowerCase() === "select") {
              rowData.push(input.options[input.selectedIndex].text);
            } else {
              rowData.push(input.value);
            }
          } else {
            rowData.push(cell.textContent.trim());
          }
        });
        // Agregar celda de firma
        rowData.push("____________________________");
        data.push(rowData);
      });
      doc.autoTable({
        head: headers,
        body: data,
        startY: 50,
        theme: 'grid',
        styles: { fontSize: 7, cellPadding: 4, halign: 'center', valign: 'middle' },
        headStyles: { fillColor: [0, 51, 102] },
        columnStyles: { text: { cellWidth: 'auto' } }
      });
      doc.save("calificaciones_" + currentSubject + "_parcial_" + currentPartial + ".pdf");
    });
    
    document.getElementById("printGrades").addEventListener("click", () => { window.print(); });
    
    /***********************
     * CAMBIOS DE PARCIAL Y MATERIA
     ***********************/
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        currentPartial = parseInt(btn.getAttribute("data-partial"));
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        updatePartialDisplay();
        buildGradeTable();
        buildTeamTable();
      });
    });
    document.getElementById("subjectSelect").addEventListener("change", (e) => {
      currentSubject = e.target.value;
      updateRubricDisplay();
      buildDynamicHeader();
      buildTeamTable();
      buildGradeTable();
    });
    
    /***********************
     * CARGA INICIAL
     ***********************/
    buildSubjectSelect();
    updateRubricDisplay();
    updatePartialDisplay();
    buildDynamicHeader();
    buildTeamTable();
    buildGradeTable();
    
    /***********************
     * INICIO DE SESIÓN Y CONFIGURACIÓN DE CREDENCIALES
     ***********************/
    window.addEventListener("load", () => {
      const loginModal = document.getElementById("loginModal");
      loginModal.style.display = "block";
      const storedUser = localStorage.getItem("appUser") || "admin";
      const storedPass = localStorage.getItem("appPass") || "admin123";
      document.getElementById("loginBtn").addEventListener("click", () => {
        const user = document.getElementById("loginUser").value.trim();
        const pass = document.getElementById("loginPass").value;
        if(user === storedUser && pass === storedPass) {
          isLoggedIn = true;
          loginModal.style.display = "none";
          document.getElementById("appContainer").style.display = "block";
          if(readOnlyMode) { setReadOnly(); }
        } else {
          alert("Usuario o contraseña incorrectos");
        }
      });
    });
    
    // Si se abre en modo solo lectura (por URL ?readonly=true), deshabilitar edición
    function setReadOnly() {
      document.querySelectorAll("input, select, button").forEach(el => { el.disabled = true; });
      // Mostrar solo el contenido (por ejemplo, ocultar botones de agregar evaluaciones, etc.)
      document.getElementById("appContainer").style.border = "none";
    }
  </script>
</body>
</html>
